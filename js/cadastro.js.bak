/**
 * cadastro.js
 * 
 * Lógica específica da tela de cadastro de clientes e projetos
 * Este arquivo contém todas as funções relacionadas à tela de cadastro
 * do Sistema de Controle de Compras e Recebimento
 */

// Aguarda o carregamento completo do DOM
document.addEventListener('DOMContentLoaded', function() {
    // Inicializa os componentes da página
    inicializarComponentes();
    
    // Carrega a lista de clientes cadastrados
    carregarClientes();
    
    // Configura os listeners de eventos
    configurarEventListeners();
});

/**
 * Inicializa os componentes da interface
 * Configura datepickers, selects e outros elementos
 */
function inicializarComponentes() {
    // Inicializa os datepickers
    flatpickr(".datepicker", {
        locale: "pt",
        dateFormat: "d/m/Y",
        allowInput: true
    });
    
    // Inicializa os selects com Select2
    $(document).ready(function() {
        $('#filtroCliente').select2({
            placeholder: "Selecione um cliente",
            allowClear: true
        });
        
        $('#filtroStatus').select2({
            placeholder: "Selecione um status",
            allowClear: true
        });
    });
}

/**
 * Configura os listeners de eventos para os elementos da página
 */
function configurarEventListeners() {
    // Botão Novo Cadastro
    document.getElementById('btnNovoCadastro').addEventListener('click', function() {
        // Limpa o formulário antes de abrir o modal
        document.getElementById('formCadastro').reset();
        
        // Oculta todas as áreas de projeto
        document.querySelectorAll('.area-projeto').forEach(area => {
            area.classList.add('d-none');
        });
        
        // Exibe o modal
        const modalCadastro = new bootstrap.Modal(document.getElementById('modalCadastro'));
        modalCadastro.show();
    });
    
    // Checkboxes de tipo de projeto
    document.querySelectorAll('.tipo-projeto').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const tipoId = this.id;
            const areaTipo = document.getElementById('area' + tipoId.replace('tipo', ''));
            
            if (this.checked && areaTipo) {
                areaTipo.classList.remove('d-none');
            } else if (areaTipo) {
                areaTipo.classList.add('d-none');
            }
        });
    });
    
    // Checkbox de terceirização para Alumínio
    document.getElementById('aluminioTerceirizado').addEventListener('change', function() {
        const areaTerceirizado = document.getElementById('areaAluminioTerceirizado');
        const areaProducao = document.getElementById('areaAluminioProducao');
        
        if (this.checked) {
            areaTerceirizado.classList.remove('d-none');
            areaProducao.classList.add('d-none');
        } else {
            areaTerceirizado.classList.add('d-none');
            areaProducao.classList.remove('d-none');
        }
    });
    
    // Botão Salvar Cadastro
    document.getElementById('btnSalvarCadastro').addEventListener('click', salvarCadastro);
    
    // Botão Filtrar
    document.getElementById('btnFiltrar').addEventListener('click', aplicarFiltros);
    
    // Botão Limpar Filtros
    document.getElementById('btnLimparFiltros').addEventListener('click', limparFiltros);
}

/**
 * Carrega a lista de clientes cadastrados do Firebase
 * e atualiza a tabela na interface
 */
function carregarClientes() {
    // Referência à tabela de clientes
    const tabelaClientes = document.getElementById('tabelaClientes');
    const nenhumCliente = document.getElementById('nenhumCliente');
    
    // Limpa a tabela
    tabelaClientes.innerHTML = '';
    
    // Busca os clientes no Firebase
    dbRef.clientes.once('value')
        .then(snapshot => {
            const clientes = snapshot.val();
            
            // Verifica se existem clientes cadastrados
            if (objetoVazio(clientes)) {
                nenhumCliente.classList.remove('d-none');
                return;
            }
            
            nenhumCliente.classList.add('d-none');
            
            // Preenche o select de filtro de clientes
            const filtroCliente = document.getElementById('filtroCliente');
            filtroCliente.innerHTML = '<option value="">Todos os clientes</option>';
            
            // Adiciona cada cliente à tabela
            Object.keys(clientes).forEach(id => {
                const cliente = clientes[id];
                
                // Adiciona ao filtro
                const option = document.createElement('option');
                option.value = id;
                option.textContent = cliente.nome;
                filtroCliente.appendChild(option);
                
                // Cria a linha da tabela
                const tr = document.createElement('tr');
                
                // Define a classe de acordo com o status
                if (cliente.status === 'Em andamento') {
                    tr.classList.add('table-warning');
                } else if (cliente.status === 'Concluído') {
                    tr.classList.add('table-success');
                }
                
                // Formata a data de criação
                const dataCriacao = formatarData(cliente.dataCriacao);
                
                // Conteúdo da linha
                tr.innerHTML = `
                    <td>${cliente.nome}</td>
                    <td>${dataCriacao}</td>
                    <td>
                        <span class="badge ${getBadgeClass(cliente.status)}">${cliente.status || 'Não iniciado'}</span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-info me-1" onclick="visualizarCliente('${id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-primary" onclick="editarCliente('${id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                    </td>
                `;
                
                tabelaClientes.appendChild(tr);
            });
        })
        .catch(error => {
            console.error('Erro ao carregar clientes:', error);
            mostrarNotificacao('Erro ao carregar clientes. Tente novamente.', 'danger');
        });
}

/**
 * Retorna a classe do badge de acordo com o status
 * 
 * @param {string} status - Status do cliente
 * @returns {string} - Classe CSS para o badge
 */
function getBadgeClass(status) {
    switch (status) {
        case 'Em andamento':
            return 'bg-warning';
        case 'Concluído':
            return 'bg-success';
        default:
            return 'bg-secondary';
    }
}

/**
 * Salva um novo cadastro de cliente e seus projetos no Firebase
 */
function salvarCadastro() {
    // Referência ao formulário
    const form = document.getElementById('formCadastro');
    
    // Valida o formulário
    if (!validarFormulario(form)) {
        mostrarNotificacao('Preencha todos os campos obrigatórios.', 'warning');
        return;
    }
    
    // Obtém os valores do formulário
    const nomeCliente = document.getElementById('cliente').value;
    const prazoEntrega = document.getElementById('dataPrazoEntrega').value;
    
    // Converte a data para timestamp
    const dataParts = prazoEntrega.split('/');
    const prazoEntregaTimestamp = new Date(
        parseInt(dataParts[2]), 
        parseInt(dataParts[1]) - 1, 
        parseInt(dataParts[0])
    ).getTime();
    
    // Verifica se pelo menos um tipo de projeto foi selecionado
    const tiposSelecionados = document.querySelectorAll('.tipo-projeto:checked');
    if (tiposSelecionados.length === 0) {
        mostrarNotificacao('Selecione pelo menos um tipo de projeto.', 'warning');
        return;
    }
    
    // Cria o objeto do cliente
    const clienteId = gerarId();
    const cliente = {
        nome: nomeCliente,
        dataCriacao: Date.now(),
        prazoEntrega: prazoEntregaTimestamp,
        status: 'Não iniciado',
        ultimaAtualizacao: Date.now()
    };
    
    // Cria o objeto de projetos
    const projetos = {};
    
    // Processa cada tipo de projeto selecionado
    tiposSelecionados.forEach(checkbox => {
        const tipo = checkbox.value;
        
        // Objeto para armazenar informações do tipo de projeto
        const tipoProjeto = {
            terceirizado: false,
            listas: {}
        };
        
        // Verifica se é terceirizado (apenas para tipos que suportam terceirização)
        if (['Aluminio', 'Brise', 'ACM', 'Outros'].includes(tipo)) {
            const checkboxTerceirizado = document.getElementById(`${tipo.toLowerCase()}Terceirizado`);
            
            if (checkboxTerceirizado && checkboxTerceirizado.checked) {
                tipoProjeto.terceirizado = true;
                
                // Adiciona informações de terceirização
                const empresa = document.getElementById(`empresa${tipo}`).value;
                const dataSolicitacao = document.getElementById(`dataSolicitacao${tipo}`).value;
                const prazoEntregaTerceirizado = document.getElementById(`prazoEntrega${tipo}`).value;
                
                tipoProjeto.empresa = empresa;
                
                // Converte as datas para timestamp
                if (dataSolicitacao) {
                    const parts = dataSolicitacao.split('/');
                    tipoProjeto.dataSolicitacao = new Date(
                        parseInt(parts[2]), 
                        parseInt(parts[1]) - 1, 
                        parseInt(parts[0])
                    ).getTime();
                }
                
                if (prazoEntregaTerceirizado) {
                    const parts = prazoEntregaTerceirizado.split('/');
                    tipoProjeto.prazoEntrega = new Date(
                        parseInt(parts[2]), 
                        parseInt(parts[1]) - 1, 
                        parseInt(parts[0])
                    ).getTime();
                }
            }
        }
        
        // Adiciona o tipo de projeto ao objeto de projetos
        projetos[tipo] = tipoProjeto;
    });
    
    // Salva o cliente no Firebase
    dbRef.clientes.child(clienteId).set(cliente)
        .then(() => {
            // Salva os projetos do cliente
            return dbRef.projetos.child(clienteId).set(projetos);
        })
        .then(() => {
            // Processa os arquivos de listas
            return processarArquivosListas(clienteId, tiposSelecionados);
        })
        .then(() => {
            // Exibe mensagem de sucesso
            mostrarNotificacao('Cliente cadastrado com sucesso!', 'success');
            
            // Fecha o modal
            const modalCadastro = bootstrap.Modal.getInstance(document.getElementById('modalCadastro'));
            modalCadastro.hide();
            
            // Recarrega a lista de clientes
            carregarClientes();
        })
        .catch(error => {
            console.error('Erro ao salvar cadastro:', error);
            mostrarNotificacao('Erro ao salvar cadastro. Tente novamente.', 'danger');
        });
}

/**
 * Processa os arquivos de listas para cada tipo de projeto
 * 
 * @param {string} clienteId - ID do cliente
 * @param {NodeList} tiposSelecionados - Tipos de projeto selecionados
 * @returns {Promise} - Promise que resolve quando todos os arquivos forem processados
 */
function processarArquivosListas(clienteId, tiposSelecionados) {
    // Array para armazenar todas as promessas de processamento
    const promessas = [];
    
    // Para cada tipo de projeto
    tiposSelecionados.forEach(checkbox => {
        const tipo = checkbox.value;
        
        // Verifica se o tipo é terceirizado
        const checkboxTerceirizado = document.getElementById(`${tipo.toLowerCase()}Terceirizado`);
        if (checkboxTerceirizado && checkboxTerceirizado.checked) {
            // Se for terceirizado, não processa arquivos
            return;
        }
        
        // Define as listas para cada tipo de projeto
        let listas = [];
        
        switch (tipo) {
            case 'PVC':
                listas = [
                    { id: 'listaPVC', nome: 'LPVC' },
                    { id: 'listaReforco', nome: 'LReforco' },
                    { id: 'listaFerragens', nome: 'LFerragens' },
                    { id: 'listaVidros', nome: 'LVidros' },
                    { id: 'listaEsteira', nome: 'LEsteira' },
                    { id: 'listaMotor', nome: 'LMotor' },
                    { id: 'listaAcabamento', nome: 'LAcabamento' },
                    { id: 'listaTelaRetratil', nome: 'LTelaRetratil' },
                    { id: 'listaAco', nome: 'LAco' },
                    { id: 'listaOutrosPVC', nome: 'LOutros' }
                ];
                break;
            case 'Aluminio':
                listas = [
                    { id: 'listaPerfil', nome: 'LPerfil' },
                    { id: 'listaContraMarco', nome: 'LContraMarco' },
                    { id: 'listaFerragensAluminio', nome: 'LFerragens' },
                    { id: 'listaVidroAluminio', nome: 'LVidro' },
                    { id: 'listaMotorAluminio', nome: 'LMotor' },
                    { id: 'listaEsteiraAluminio', nome: 'LEsteira' },
                    { id: 'listaAcabamentoAluminio', nome: 'LAcabamento' },
                    { id: 'listaTelaRetratilAluminio', nome: 'LTelaRetratil' },
                    { id: 'listaOutrosAluminio', nome: 'LOutros' }
                ];
                break;
            // Outros tipos de projeto seguiriam o mesmo padrão
        }
        
        // Para cada lista do tipo de projeto
        listas.forEach(lista => {
            const inputFile = document.getElementById(lista.id);
            
            // Verifica se há arquivo selecionado
            if (inputFile && inputFile.files.length > 0) {
                // Cria uma promessa para processar o arquivo
                const promessa = new Promise((resolve, reject) => {
                    // Chama a função de processamento de arquivo (implementada em processamento-arquivos.js)
                    processarArquivo(inputFile.files[0], clienteId, tipo, lista.nome)
                        .then(resolve)
                        .catch(reject);
                });
                
                // Adiciona a promessa ao array
                promessas.push(promessa);
            }
        });
    });
    
    // Retorna uma promessa que resolve quando todas as promessas de processamento forem resolvidas
    return Promise.all(promessas);
}

/**
 * Aplica os filtros selecionados à lista de clientes
 */
function aplicarFiltros() {
    const filtroCliente = document.getElementById('filtroCliente').value;
    const filtroData = document.getElementById('filtroData').value;
    const filtroStatus = document.getElementById('filtroStatus').value;
    
    // Referência à tabela de clientes
    const tabelaClientes = document.getElementById('tabelaClientes');
    const nenhumCliente = document.getElementById('nenhumCliente');
    
    // Limpa a tabela
    tabelaClientes.innerHTML = '';
    
    // Busca os clientes no Firebase
    dbRef.clientes.once('value')
        .then(snapshot => {
            const clientes = snapshot.val();
            
            // Verifica se existem clientes cadastrados
            if (objetoVazio(clientes)) {
                nenhumCliente.classList.remove('d-none');
                return;
            }
            
            nenhumCliente.classList.add('d-none');
            
            // Filtra os clientes
            let clientesFiltrados = Object.keys(clientes);
            
            // Filtra por cliente
            if (filtroCliente) {
                clientesFiltrados = clientesFiltrados.filter(id => id === filtroCliente);
            }
            
            // Filtra por status
            if (filtroStatus) {
                clientesFiltrados = clientesFiltrados.filter(id => clientes[id].status === filtroStatus);
            }
            
            // Filtra por data
            if (filtroData) {
                const dataParts = filtroData.split('/');
                const dataFiltro = new Date(
                    parseInt(dataParts[2]), 
                    parseInt(dataParts[1]) - 1, 
                    parseInt(dataParts[0])
                ).setHours(0, 0, 0, 0);
                
                clientesFiltrados = clientesFiltrados.filter(id => {
                    const dataCriacao = new Date(clientes[id].dataCriacao).setHours(0, 0, 0, 0);
                    return dataCriacao === dataFiltro;
                });
            }
            
            // Verifica se há resultados após a filtragem
            if (clientesFiltrados.length === 0) {
                tabelaClientes.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center">Nenhum cliente encontrado com os filtros selecionados.</td>
                    </tr>
                `;
                return;
            }
            
            // Adiciona cada cliente filtrado à tabela
            clientesFiltrados.forEach(id => {
                const cliente = clientes[id];
                
                // Cria a linha da tabela
                const tr = document.createElement('tr');
                
                // Define a classe de acordo com o status
                if (cliente.status === 'Em andamento') {
                    tr.classList.add('table-warning');
                } else if (cliente.status === 'Concluído') {
                    tr.classList.add('table-success');
                }
                
                // Formata a data de criação
                const dataCriacao = formatarData(cliente.dataCriacao);
                
                // Conteúdo da linha
                tr.innerHTML = `
                    <td>${cliente.nome}</td>
                    <td>${dataCriacao}</td>
                    <td>
                        <span class="badge ${getBadgeClass(cliente.status)}">${cliente.status || 'Não iniciado'}</span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-info me-1" onclick="visualizarCliente('${id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-primary" onclick="editarCliente('${id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                    </td>
                `;
                
                tabelaClientes.appendChild(tr);
            });
        })
        .catch(error => {
            console.error('Erro ao aplicar filtros:', error);
            mostrarNotificacao('Erro ao aplicar filtros. Tente novamente.', 'danger');
        });
}

/**
 * Limpa os filtros e recarrega a lista de clientes
 */
function limparFiltros() {
    // Limpa os campos de filtro
    document.getElementById('filtroCliente').value = '';
    document.getElementById('filtroData').value = '';
    document.getElementById('filtroStatus').value = '';
    
    // Atualiza o Select2
    $('#filtroCliente').trigger('change');
    $('#filtroStatus').trigger('change');
    
    // Recarrega a lista de clientes
    carregarClientes();
}

/**
 * Valida o formulário de cadastro
 * 
 * @param {HTMLFormElement} form - Formulário a ser validado
 * @returns {boolean} - true se o formulário for válido, false caso contrário
 */
function validarFormulario(form) {
    // Verifica se os campos obrigatórios estão preenchidos
    const camposObrigatorios = form.querySelectorAll('[required]');
    
    for (const campo of camposObrigatorios) {
        if (!campo.value) {
            campo.classList.add('is-invalid');
            return false;
        } else {
            campo.classList.remove('is-invalid');
        }
    }
    
    return true;
}

/**
 * Gera um ID único para o cliente
 * 
 * @returns {string} - ID único
 */
function gerarId() {
    // Gera um ID aleatório
    return 'aaaaa' + Math.random().toString(36).substring(2, 7);
}

/**
 * Formata uma data timestamp para exibição
 * 
 * @param {number} timestamp - Timestamp da data
 * @returns {string} - Data formatada
 */
function formatarData(timestamp) {
    if (!timestamp) return '-';
    
    const data = new Date(timestamp);
    
    // Formata a data como dd/mm/aaaa
    return `${data.getDate().toString().padStart(2, '0')}/${(data.getMonth() + 1).toString().padStart(2, '0')}/${data.getFullYear()}`;
}

/**
 * Verifica se um objeto está vazio
 * 
 * @param {Object} obj - Objeto a ser verificado
 * @returns {boolean} - true se o objeto estiver vazio, false caso contrário
 */
function objetoVazio(obj) {
    return obj === null || obj === undefined || Object.keys(obj).length === 0;
}

/**
 * Exibe uma notificação na tela
 * 
 * @param {string} mensagem - Mensagem a ser exibida
 * @param {string} tipo - Tipo da notificação (success, danger, warning, info)
 */
function mostrarNotificacao(mensagem, tipo) {
    // Cria o elemento de notificação
    const notificacao = document.createElement('div');
    notificacao.className = `alert alert-${tipo} alert-dismissible fade show notification`;
    notificacao.innerHTML = `
        ${mensagem}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
    `;
    
    // Adiciona a notificação ao corpo da página
    document.body.appendChild(notificacao);
    
    // Remove a notificação após 5 segundos
    setTimeout(() => {
        notificacao.classList.remove('show');
        setTimeout(() => {
            notificacao.remove();
        }, 300);
    }, 5000);
}

/**
 * Edita um cliente existente
 * 
 * @param {string} clienteId - ID do cliente a ser editado
 */
function editarCliente(clienteId) {
    // Esta função seria implementada para permitir a edição de clientes
    alert('Funcionalidade de edição não implementada nesta versão.');
}
